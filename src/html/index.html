<html>
<head>
    <script src="./assets/SystemJS.js" type="application/javascript"></script>
    <script src="./assets/jquery-3.1.1.min.js" type="application/javascript"></script>
    <script src="app.js" type="application/javascript"></script>
    <link rel="stylesheet" type="text/css" href="./css/debugger.css">
    <link rel="stylesheet" type="text/css" href="./css/main.css">
</head>
<body>

<div style="display: flex; flex-direction: row;">
    <div style="display: flex; flex-direction: column; ">
        <div id="screenContainer">
            <canvas id="screen"></canvas>
        </div>

        <div class="controllerRow">
            <div class="controllerCol">

                <div>
                    <input size="2" id="tickfor" value="1">
                    <button onclick="tick()">Tick</button>
                </div>
                <div>
                    <button onclick="run()">Run</button>
                    <button onclick="stop()">Stop</button>
                </div>
            </div>

            <div class="controllerCol">

                <div>
                    Ticks per frame:
                    <input size="2" id="tpf" value="20000">
                </div>
                <div>
                    Break at pc:
                    <input id="breakpoint" size="3">
                    <button id="setbreak" onclick="setBreakPoint()">Set</button>
                </div>

            </div>

            <div style="display:flex;margin-left:auto;margin-bottom:auto">
                <button onclick="grow()">+</button>
                <button onclick="shrink()">-</button>
            </div>
        </div>


        <!-- Log Console -->
        <div class="debugger">
            <div style="display: flex; flex-direction: row; margin-left: 10px; flex-grow: 1; width:520px">
                <fieldset style="width: 100%">
                    <legend>LOG</legend>
                    <div class="log" style="color: #bebebe; display: inline-block">
                        <ul></ul>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>


    <!-- Debugger -->
    <div class="debugger">
        <div style="display: flex; flex-direction: row;">
            <fieldset style="flex-grow: 1">
                <legend>CARTIDGE</legend>
                <div style="color: #bebebe; display: inline-block">
                    <ul style="list-style: none;">
                        <li>
                            <span class="header">URL:</span>
                            <span id="url"></span>
                        </li>
                        <li>
                            <span class="header">Type:</span>
                            <span id="type">0</span>
                        </li>

                    </ul>
                </div>
            </fieldset>
        </div>
        <div style="display: flex; flex-direction: row;">
            <fieldset>
                <legend>CONSOLE</legend>
                <div style="color: #bebebe; display: inline-block">
                    <ul style="list-style: none;">
                        <li>
                            <span class="header">CPU Cycles:</span>
                            <span id="cpucycles"></span>
                        </li>
                        <li>
                            <span class="header">PPU Cycles:</span>
                            <span id="ppucycles">0</span>
                        </li>
                        <li>
                            <span class="header">Scanlines:</span>
                            <span id="scanlines">0</span>
                        </li>
                        <li>
                            <span class="header">Ticks:</span>
                            <span id="ticks"></span>
                        </li>
                    </ul>
                </div>
            </fieldset>
            <fieldset>
                <legend>OPERATION</legend>
                <div style="color: #bebebe; display: inline-block">
                    <ul style="list-style: none;">
                        <li>
                            <span class="header">Code:</span>
                            <span id="opcode"></span></li>
                        <li>
                        <li>
                            <span class="header">Name:</span>
                            <span id="opname"></span></li>
                        <li>
                            <span class="header">Mode:</span>
                            <span id="opmode"></span>
                        </li>
                        <li>
                            <span class="header">Address:</span>
                            <span id="opaddr"></span>
                        </li>
                        <li>
                            <span class="header">Operand:</span>
                            <span id="operand"></span>
                        </li>
                    </ul>
                </div>
            </fieldset>
        </div>
        <div style="display: flex; flex-direction: row;">
            <fieldset>
                <legend>CPU</legend>
                <div style="color: #bebebe; display: inline-block">
                    <ul style="list-style: none;">
                        <li>
                            <span class="header">PC:</span>
                            <span id="pc"></span>
                        </li>
                        <li>
                            <span class="header">SP:</span>
                            <span id="sp"></span>
                        </li>

                        <br/>
                        <span class="header">Flags:</span>
                        <div id="zero"></div>
                        <div id="subtract"></div>
                        <div id="halfcarry"></div>
                        <div id="fullcarry"></div>

                        </li>

                        <li>
                            <span class="header">AF:</span>
                            <span id="af"></span>
                        </li>
                        <li>
                            <span class="header">BC:</span>
                            <span id="bc"></span>
                        </li>
                        <li>
                            <span class="header">DE:</span>
                            <span id="de"></span>
                        </li>
                        <li>
                            <span class="header">HL:</span>
                            <span id="hl"></span>
                        </li>
                    </ul>
                </div>
            </fieldset>
            <fieldset>
                <legend>PPU Registers</legend>
                <div style="color: #bebebe; display: inline-block">
                    <ul style="list-style: none;">
                        <li>
                            <span class="header">LCDC:</span>
                            <span id="lcdc"></span>
                        </li>
                        <li>
                            <span class="header">STAT:</span>
                            <span id="stat"></span>
                        </li>

                        <br/>
                        <li>
                            <span class="header">LY:</span>
                            <span id="ly"></span>
                        </li>

                        <li>
                            <span class="header">LYC:</span>
                            <span id="lyc"></span>
                        </li>
                    </ul>
                </div>
            </fieldset>
        </div>

        <div style="display: flex; flex-direction: row;">
            <fieldset>
                <legend>Interrupts</legend>
                <div style="color: #bebebe; display: inline-block">
                    <ul style="list-style: none;">
                        <li>
                            <span class="header">IME:</span>
                            <span id="ime"></span>
                        </li>
                        <li>
                            <span class="header">IE:</span>
                            <span id="ie"></span>
                        </li>

                        <br/>
                        <li>
                            <span class="header">IF:</span>
                            <span id="if"></span>
                        </li>
                    </ul>
                </div>

            </fieldset>

            <div>
                <legend>Run Conditions</legend>
                <div style="color: #bebebe; display: inline-block">
                </div>
            </div>
        </div>

        <!--Stack-->
        <div id="stack" style="display: flex; flex-direction: row;">
            <fieldset>
                <legend>STACK</legend>
                <ul style="list-style:none"></ul>
            </fieldset>
        </div>
        <button onclick="toggleDebug()">Debug</button>
    </div>

    <!--VRAM viewer-->

    <div class="debugger">
        <div style="display: flex; flex-direction: row">
            <canvas id="bgmap"></canvas>
        </div>
        <button onclick="renderBGmap()">RenderBGmap</button>
        <div style="display: flex; flex-direction: row">
            <canvas id="tilemap"></canvas>
        </div>
        <button onclick="renderTilemap()">RenderTilemap</button>
    </div>


</div>

<script>
    var gameboy = null;
    var debug = null;
    var breakpoint = false;

    var loadGameBoy = function () {
        System.import('gameboy').then(function (e) {
            try {
                gameboy = new e.GameBoy();
            } catch (e) {
                console.error("Unable to load GameBoy");
                console.error(e);
                return;
            }

            //gameboy.load("./roms/cpu_instrs/individual/01-special.gb");
            gameboy.load("./roms/Tetris.gb");
            gameboy.reset();
            loadDebugger();
            console.info("Gameboy is ready!");
        }).catch(
            function (err) {
                console.error("Unable to load GameBoy");
                console.error(err);
            }
        );
    }

    var loadDebugger = function () {
        System.import('debugger').then(function (e) {
            try {
                debug = e.Debugger;
            } catch (e) {
                console.error("Unable to load Debugger");
                console.error(e);
                return;
            }
            debug.init(gameboy);
        }).catch(
            function (err) {
                console.error("Unable to load Debugger");
                console.error(err);
            }
        );
    }

    loadGameBoy();

    var tick = function () {
        gameboy.tickUntil($('#tickfor').val());
    }

    var run = function () {
        gameboy.tickUntil(-1);
    }

    var stop = function () {
        gameboy.counts = 0;
    }

    var grow = function () {
        gameboy.ppu.screen.setZoom(gameboy.ppu.screen.getZoom() + 1);
    }

    var shrink = function () {
        gameboy.ppu.screen.setZoom(gameboy.ppu.screen.getZoom() - 1);
    }

    var toggleDebug = function () {
        var _tpf = $('#tpf').val();
        return function () {
            _tpf = $('#tpf').val();
            debug.status = !debug.status;
            if (debug.status) {
                debug.clearLog();
                debug.display();
                _tpf = gameboy.tpf;
                gameboy.tpf = 1;
            } else {
                console.log(_tpf);
                gameboy.tpf = _tpf;
            }
        }
    }();

    var setBreakPoint = function () {
        var val = parseInt($("#breakpoint").val(), 16);
        gameboy.setPCBreak(val);
    }

    var renderBGmap = function(){
        debug.renderBGmap();
    }

    var renderTilemap = function(){
        debug.renderTilemap();
    }

    //Debugger hot keys
    $("#breakpoint").blur(function () {
        if ($("#breakpoint").val() != 0) {
            $("#setbreak").click();
        }
    });

    $(document).keypress(function (event) {
        //$(this.body).prepend("<span>" + event.keyCode + "</span>");
        switch (event.keyCode) {
            case 13:
                toggleDebug();
                break;
            case 114:
                run();
                break;
            case 115:
                stop();
                break;
            case 116:
                tick();
                break;
        }
    });

    $(document).keydown(function (event) {
        if (event.keyCode == 16) {
            var input = $("#breakpoint");
            if (input.is(":focus")) {
                input.blur();
            } else {
                input.focus();
            }
        }
    });

</script>
</body>
</html>